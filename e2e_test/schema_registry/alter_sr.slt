# Before running this test, seed data into kafka:
#   python3 e2e_test/schema_registry/pb.py <brokerlist> <schema-registry-url> <topic> <num-records> <pb_message>

statement ok
CREATE SOURCE src_user WITH (
    connector = 'kafka',
    topic = 'sr_pb_test',
    properties.bootstrap.server = 'message_queue:29092',
    scan.startup.mode = 'earliest'
)
FORMAT PLAIN ENCODE PROTOBUF(
    schema.registry = 'http://message_queue:8081',
    message = 'test.User'
);

# Changing type is not allowed
statement error Feature is not yet implemented: this altering statement will drop columns, which is not supported yet: \(city: character varying\)
ALTER SOURCE src_user FORMAT PLAIN ENCODE PROTOBUF(
    schema.registry = 'http://message_queue:8081',
    message = 'test.UserWithNewType'
);

# Changing format/encode is not allowed
statement error Feature is not yet implemented: the original definition is FORMAT Plain ENCODE Protobuf, and altering them is not supported yet
ALTER SOURCE src_user FORMAT NATIVE ENCODE PROTOBUF(
    schema.registry = 'http://message_queue:8081',
    message = 'test.User'
);

statement ok
ALTER SOURCE src_user FORMAT PLAIN ENCODE PROTOBUF(
    schema.registry = 'http://message_queue:8081',
    message = 'test.UserWithMoreFields'
);

# Dropping columns is not allowed
statement error Feature is not yet implemented: this altering statement will drop columns, which is not supported yet: \(age: integer\)
ALTER SOURCE src_user FORMAT PLAIN ENCODE PROTOBUF(
    schema.registry = 'http://message_queue:8081',
    message = 'test.User'
);

statement ok
CREATE TABLE t_more_fields (
    id INT,
    name VARCHAR,
    address VARCHAR,
    city VARCHAR,
    gender INT,
    age INT,
);

statement ok
INSERT INTO t_more_fields VALUES
    (10086, 'Rising', 'Wave', 'Labs', 0, 24),
    (10087, 'Rising', 'Wave', 'Labs', 1, 25);

statement ok
CREATE SINK sink_more_fields FROM t_more_fields WITH(
    connector = 'kafka',
    topic = 'sr_pb_test',
    properties.bootstrap.server = 'message_queue:29092'
) FORMAT PLAIN ENCODE PROTOBUF(
    force_append_only='true',
    schema.location = 'file:///risingwave/user.pb',
    message = 'test.UserWithMoreFields'
);

statement ok
flush;

sleep 10s

statement ok
CREATE MATERIALIZED VIEW mv_more_fields as SELECT * FROM src_user;

query II
SELECT MAX(age), MIN(age) FROM mv_more_fields;
----
25 24

statement ok
DROP MATERIALIZED VIEW mv_more_fields;

statement ok
DROP SINK sink_more_fields;

statement ok
DROP TABLE t_more_fields;

statement ok
DROP SOURCE src_user;
