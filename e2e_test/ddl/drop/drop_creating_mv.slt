statement ok
create table t(v1 int);

statement ok
insert into t select * from generate_series(1, 10000);

statement ok
flush;

statement ok
set streaming_rate_limit=1;

############## Test drop foreground mv
skipif in-memory
system ok
risedev psql -c 'create materialized view m1 as select * from t;' &

skipif in-memory
sleep 5s

skipif in-memory
statement ok
drop materialized view m1;

############## Test drop background mv BEFORE recovery
statement ok
set background_ddl=true;

skipif in-memory
statement ok
create materialized view m1 as select * from t;

skipif in-memory
sleep 5s

skipif in-memory
statement ok
drop materialized view m1;

############## Test drop background mv AFTER recovery
statement ok
set background_ddl=true;

skipif in-memory
statement ok
create materialized view m1 as select * from t;

skipif in-memory
sleep 5s

skipif in-memory
statement ok
recover;

skipif in-memory
sleep 10s

skipif in-memory
statement ok
drop materialized view m1;

############## Make sure the mv can still be successfully created later.
statement ok
set streaming_rate_limit=default;

statement ok
set background_ddl=false;

statement ok
create materialized view m1 as select * from t;

statement ok
drop materialized view m1;

statement ok
drop table t;