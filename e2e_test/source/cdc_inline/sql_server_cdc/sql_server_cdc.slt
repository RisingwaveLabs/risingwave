
control substitution on

# ------------ data prepare stage ------------
system ok
sqlcmd -d master -Q 'create database mydb;' -b

system ok
sqlcmd -C -i e2e_test/source/cdc_inline/sql_server_cdc/sql_server_cdc_prepare.sql -b

# ------------ validate stage ------------
# TODO(kexiang): add more tests here
# invalid username
# invalid password
# invalid table name
# invalid primary key
# column name mismatch
# column data type mismatch
# format & encode provided and match with debezium json, this is okay
# format & encode provided but mismatch with debezium json, this is not allowed


statement error
CREATE TABLE orders (
  order_id INT PRIMARY KEY,
  order_date BIGINT,
  customer_name VARCHAR,
  price DECIMAL,
  product_id INT,
  order_status SMALLINT
) WITH (
  connector = 'sqlserver-cdc',
  hostname = '${SQLCMDSERVER:sqlserver-server}',
  port = '${SQLCMDPORT:1433}',
  username = '${SQLCMDUSER:SA}',
  password = '${SQLCMDPASSWORD}',
  table.name = 'orders',
  database.name = '${SQLCMDDBNAME}',
);

statement error
CREATE TABLE single_type (
  id INT,
  c_time time,
  PRIMARY KEY (id)
)  WITH (
  connector = 'sqlserver-cdc',
  hostname = '${SQLCMDSERVER:sqlserver-server}',
  port = '${SQLCMDPORT:1433}',
  username = '${SQLCMDUSER:SA}',
  password = '${SQLCMDPASSWORD}',
  table.name = 'single_type',
  database.name = '${SQLCMDDBNAME}',
);

statement error
CREATE TABLE sqlserver_all_data_types (
  id INT PRIMARY KEY,
  c_bit BOOLEAN,
  c_tinyint SMALLINT,
  c_smallint SMALLINT,
  c_int INTEGER,
  c_bigint BIGINT,
  c_decimal DECIMAL,
  c_real REAL,
  c_float FLOAT,
  c_varchar VARCHAR,
  c_varbinary BYTEA,
  c_date DATE,
  c_time TIME,
  c_datetime2 TIMESTAMP,
  c_datetimeoffset TIMESTAMPTZ
) WITH (
  connector = 'sqlserver-cdc',
  hostname = '${SQLCMDSERVER:sqlserver-server}',
  port = '${SQLCMDPORT:1433}',
  username = '${SQLCMDUSER:SA}',
  password = '${SQLCMDPASSWORD}',
  table.name = 'sqlserver_all_data_types',
  database.name = '${SQLCMDDBNAME}',
);


# ------------ Create source/table/mv stage ------------
# create a cdc source job, which format fixed to `FORMAT PLAIN ENCODE JSON`
statement ok
CREATE SOURCE mssql_source WITH (
    connector = 'sqlserver-cdc',
    hostname = '${SQLCMDSERVER:sqlserver-server}',
    port = '${SQLCMDPORT:1433}',
    username = '${SQLCMDUSER:SA}',
    password = '${SQLCMDPASSWORD}',
    database.name = '${SQLCMDDBNAME}',
);

statement error Should not create MATERIALIZED VIEW or SELECT directly on shared CDC source
create materialized view mv as select * from mssql_source;

statement error The upstream table name must contain schema name prefix*
CREATE TABLE shared_orders (
    order_id INT,
    order_date BIGINT,
    customer_name VARCHAR,
    price DECIMAL,
    product_id INT,
    order_status SMALLINT,
    PRIMARY KEY (order_id)
)  from mssql_source table 'orders';

statement ok
CREATE TABLE shared_orders (
    order_id INT,
    order_date BIGINT,
    customer_name VARCHAR,
    price DECIMAL,
    product_id INT,
    order_status SMALLINT,
    PRIMARY KEY (order_id)
)  from mssql_source table 'dbo.orders';

statement ok
CREATE TABLE shared_single_type (
    id INT,
    c_time time,
    PRIMARY KEY (id)
) from mssql_source table 'dbo.single_type';

statement ok
CREATE TABLE shared_sqlserver_all_data_types (
    id INT,
    c_bit BOOLEAN,
    c_tinyint SMALLINT,
    c_smallint SMALLINT,
    c_int INTEGER,
    c_bigint BIGINT,
    c_decimal DECIMAL,
    c_real REAL,
    c_float FLOAT,
    c_varchar VARCHAR,
    c_varbinary BYTEA,
    c_date DATE,
    c_time TIME,
    c_datetime2 TIMESTAMP,
    c_datetimeoffset TIMESTAMPTZ,
    PRIMARY KEY (id)
) from mssql_source table 'dbo.sqlserver_all_data_types';

statement ok
create materialized view shared_orders_cnt as select count(*) as cnt from shared_orders;

statement ok
create materialized view shared_single_type_cnt as select count(*) as cnt from shared_single_type;

statement ok
create materialized view shared_sqlserver_all_data_types_cnt as select count(*) as cnt from shared_sqlserver_all_data_types;

# sleep to ensure the data in mssql tables is consumed from Debezium message instead of backfill.
sleep 20s

# ------------ check stage ------------
query I
select cnt from shared_orders_cnt;
----
3

query I
select cnt from shared_single_type_cnt;
----
1

query I
select cnt from shared_sqlserver_all_data_types_cnt;
----
3

query III
select * from shared_orders order by order_id;
----
1 1558430840000 Bob 11 1 1
2 1558430840001 Alice 21 2 1
3 1558430840002 Alice 19 2 1

query I
SELECT * from shared_single_type order by id;
----
3 23:59:59.999

query TTTTTTT
SELECT * from shared_sqlserver_all_data_types order by id;
----
1 f 0 0 0 0 0 0 0 (empty) NULL 2001-01-01 00:00:00 2001-01-01 00:00:00 2001-01-01 00:00:00+00:00
2 t 255 -32768 -2147483648 -9223372036854775808 -10 -10000 -10000 aa \xff 1990-01-01 13:59:59.123 2000-01-01 11:00:00.123 1990-01-01 00:00:01.123+00:00
3 t 127 32767 2147483647 9223372036854775807 -10 10000 10000 zzzz \xffffffff 2999-12-31 23:59:59.999 2099-12-31 23:59:59.999 2999-12-31 23:59:59.999+00:00

# ------------ kill cluster ------------
system ok
risedev kill

sleep 30s

# ------------ add rows stage ------------
system ok
sqlcmd -C -i e2e_test/source/cdc_inline/sql_server_cdc/sql_server_cdc_insert.sql -b

sleep 10s

# ------------ recover cluster ------------
system ok
risedev dev ci-1cn-1fe-with-recovery

sleep 30s

# ------------ check after recovery stage ------------

query I
select cnt from shared_orders_cnt;
----
6

query I
select cnt from shared_single_type_cnt;
----
2

query I
select cnt from shared_sqlserver_all_data_types_cnt;
----
6


query III
select * from shared_orders order by order_id;
----
1 1558430840000 Bob 11 1 1
2 1558430840001 Alice 21 2 1
3 1558430840002 Alice 19 2 1
11 1558430840000 Bob 11 1 1
12 1558430840001 Alice 21 2 1
13 1558430840002 Alice 19 2 1

query I
SELECT * from shared_single_type order by id;
----
3 23:59:59.999
13 23:59:59.999

query TTTTTTT
SELECT * from shared_sqlserver_all_data_types order by id;
----
1 f 0 0 0 0 0 0 0 (empty) NULL 2001-01-01 00:00:00 2001-01-01 00:00:00 2001-01-01 00:00:00+00:00
2 t 255 -32768 -2147483648 -9223372036854775808 -10 -10000 -10000 aa \xff 1990-01-01 13:59:59.123 2000-01-01 11:00:00.123 1990-01-01 00:00:01.123+00:00
3 t 127 32767 2147483647 9223372036854775807 -10 10000 10000 zzzz \xffffffff 2999-12-31 23:59:59.999 2099-12-31 23:59:59.999 2999-12-31 23:59:59.999+00:00
11 f 0 0 0 0 0 0 0 (empty) NULL 2001-01-01 00:00:00 2001-01-01 00:00:00 2001-01-01 00:00:00+00:00
12 t 255 -32768 -2147483648 -9223372036854775808 -10 -10000 -10000 aa \xff 1990-01-01 13:59:59.123 2000-01-01 11:00:00.123 1990-01-01 00:00:01.123+00:00
13 t 127 32767 2147483647 9223372036854775807 -10 10000 10000 zzzz \xffffffff 2999-12-31 23:59:59.999 2099-12-31 23:59:59.999 2999-12-31 23:59:59.999+00:00

# ------------ drop stage ------------
statement ok
drop source mssql_source cascade;
