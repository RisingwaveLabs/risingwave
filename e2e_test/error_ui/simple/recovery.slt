# TODO: the test triggers a recovery caused by a known issue: https://github.com/risingwavelabs/risingwave/issues/11915.
# We should consider using a mechanism designed for testing recovery instead of depending on a bug.

statement error error connecting to server: Connection refused \(os error 61\)
create table t (v decimal);

statement error error connecting to server: Connection refused \(os error 61\)
create materialized view mv as select sum(coalesce(pg_sleep(1), v)) from t;

# The bomb will be triggered after 1 seconds of sleep, so the insertion should return successfully.
statement error error connecting to server: Connection refused \(os error 61\)
insert into t values (4e28), (4e28);

# Wait for recovery to complete.
sleep 15s

# Check that there's a log entry for barrier collection failure on the mata node.
# Extract the message to check that it contains the root cause of the failure.
query error error connecting to server: Connection refused \(os error 61\)
with error as (
    select info->'collectBarrierFail'->'error' #>> '{}' as error
    from rw_catalog.rw_event_logs
    where event_type = 'COLLECT_BARRIER_FAIL'
    order by timestamp desc
    limit 1
)
select
case when error like '%get error from control stream, in worker node %: %Actor % exited unexpectedly: Executor error: %Numeric out of range%' then 'ok'
     else error
end as result
from error;

statement error error connecting to server: Connection refused \(os error 61\)
drop table t cascade;
