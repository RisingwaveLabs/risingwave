# Input with either space or `T` as date and time separator
# Input in whatever timezone
# Output always in UTC (rather than session TimeZone yet)

statement ok
SET RW_IMPLICIT_FLUSH TO true;

query T
select '2022-10-01 12:00:00-08:00'::timestamp with time zone;
----
2022-10-01 20:00:00+00:00

query T
select '2022-10-01 12:00:00+08:00'::timestamp with time zone;
----
2022-10-01 04:00:00+00:00

query T
select '2022-10-01 12:00:00+00:00'::timestamp with time zone;
----
2022-10-01 12:00:00+00:00

query T
select '2022-10-01 12:00:00Z'::timestamp with time zone;
----
2022-10-01 12:00:00+00:00

query T
select '2022-10-01T12:00:00-08:00'::timestamp with time zone;
----
2022-10-01 20:00:00+00:00

query T
select '2022-10-01T12:00:00+08:00'::timestamp with time zone;
----
2022-10-01 04:00:00+00:00

query T
select '2022-10-01T12:00:00+00:00'::timestamp with time zone;
----
2022-10-01 12:00:00+00:00

query T
select '2022-10-01T12:00:00Z'::timestamp with time zone;
----
2022-10-01 12:00:00+00:00

query T
select '2023-11-05 01:40-07:00'::timestamptz;
----
2023-11-05 08:40:00+00:00

query T
select '2023-11-05 01:40-08:00'::timestamptz;
----
2023-11-05 09:40:00+00:00

statement error
select '0'::timestamptz;

query T
select '2022-10-01 12:00:00+01:00'::timestamp with time zone BETWEEN '2022-10-01T10:59:59Z' AND '2022-10-01T11:00:01Z';
----
t

statement ok
create table t (v1 int, v2 timestamp with time zone);

statement ok
insert into t values (7, '2022-10-01 12:00:00+01:00'), (9, '2022-10-01 12:01:00+01:00'), (2, '2022-10-01 12:02:00+01:00');

query T
select v1, v2 from t where v2 BETWEEN '2022-10-01T11:00:05Z' AND '2022-10-01T11:01:05Z';
----
9 2022-10-01 11:01:00+00:00

statement ok
drop table t;

statement ok
create table t (v1 int, v2 timestamp with time zone primary key);

statement ok
insert into t values (7, '2022-10-01 12:00:00+01:00'), (9, '2022-10-01 12:01:00+01:00'), (2, '2022-10-01 12:02:00+01:00');

query T
select v1, v2 from t where v2 BETWEEN '2022-10-01T11:00:05Z' AND '2022-10-01T11:01:05Z';
----
9 2022-10-01 11:01:00+00:00

statement ok
drop table t;

statement ok
create table t (v1 timestamp with time zone[], v2 struct<a timestamp with time zone>);

statement ok
insert into t values (array['2022-10-01 12:00:00+01:00'::timestamp with time zone], row('2022-10-01 12:01:00+01:00'));

query TT
select v1[1], (v2).a from t;
----
2022-10-01 11:00:00+00:00 2022-10-01 11:01:00+00:00

statement ok
drop table t;

# Timestamptz values can also be constructed from unix epoch seconds

query T
select to_timestamp(1262349296.7890123);
----
2010-01-01 12:34:56.789012+00:00

query R
select extract(epoch from '2010-01-01 12:34:56.789012Z'::timestamp with time zone);
----
1262349296.789012

query T
select to_timestamp(extract(epoch from '2010-01-01 12:34:56.789012Z'::timestamp with time zone));
----
2010-01-01 12:34:56.789012+00:00

query R
select extract(epoch from to_timestamp(1262349296.7890125));
----
1262349296.789012

query R
select extract(epoch from to_timestamp(1262349296.7890115));
----
1262349296.789012

# If this was done in PostgreSQL under 'US/Pacific', it will return 1 hour
# earlier because there are only 23 hours in this day due to Daylight Saving.
query T
select '2022-03-13 09:00:00Z'::timestamptz + interval '1' day - interval '24' hour;
----
2022-03-13 09:00:00+00:00

# Issue #7566
# timestamptz_interval_sub
statement error out of range
select TIMESTAMP WITH TIME ZONE '2022-08-09 00:00:00' - (INTERVAL '-2147483648 days');

# timestamptz_interval_add
statement error out of range
select TIMESTAMP WITH TIME ZONE '2022-08-09 00:00:00' + (INTERVAL '-2147483648 days');

query T
select to_timestamp(1672535000) - to_timestamp(1672530000);
----
01:23:20

# timestamptz agg
query T
select max('2022-10-01 12:00:00-08:00'::timestamp with time zone);
----
2022-10-01 20:00:00+00:00

query T
select min('2022-10-01 12:00:00-08:00'::timestamp with time zone);
----
2022-10-01 20:00:00+00:00

query I
select count('2022-10-01 12:00:00-08:00'::timestamp with time zone);
----
1

query T
SELECT make_timestamptz(1973, 07, 15, 08, 15, 55.33);
----
1973-07-15 08:15:55.330+00:00

statement ok
set TimeZone to 'America/New_York';

query T
SELECT make_timestamptz(1973, 07, 15, 08, 15, 55.33);
----
1973-07-15 08:15:55.330-04:00

statement error
SELECT make_timestamptz(1910, 12, 24, 0, 0, 0, 'Nehwon/Lankhmar');
----
db error: ERROR: QueryError

Caused by these errors (recent errors listed first):
  1: Expr error
  2: Invalid parameter time_zone: 'Nehwon/Lankhmar' is not a valid timezone


query TT
WITH tzs (tz) AS (VALUES ('Europe/Prague'), ('Europe/Paris'), ('America/New_York'), ('EST'), ('EST5EDT'), ('PST8PDT')) SELECT make_timestamptz(2010, 2, 27, 3, 45, 00, tz), tz FROM tzs;
----
2010-02-26 21:45:00-05:00	Europe/Prague
2010-02-26 21:45:00-05:00	Europe/Paris
2010-02-27 03:45:00-05:00	America/New_York
2010-02-27 03:45:00-05:00	EST
2010-02-27 03:45:00-05:00	EST5EDT
2010-02-27 06:45:00-05:00	PST8PDT

query TT
WITH tzs (tz) AS (VALUES ('Europe/Prague'), ('Europe/Paris'), ('America/New_York'), ('EST'), ('EST5EDT'), ('PST8PDT')) SELECT make_timestamptz(2010, 2, 27, 3, 45, 00, tz) AT TIME ZONE 'EST5EDT', tz FROM tzs;
----
2010-02-26 21:45:00	Europe/Prague
2010-02-26 21:45:00	Europe/Paris
2010-02-27 03:45:00	America/New_York
2010-02-27 03:45:00	EST
2010-02-27 03:45:00	EST5EDT
2010-02-27 06:45:00	PST8PDT

query T
SELECT make_timestamptz(1973, 07, 15, 08, 15, 55.33, 'Asia/Manila') = '1973-07-14 20:15:55.33'::timestamptz;
----
t

statement ok
set TimeZone to 'Europe/London';

query T
SELECT make_timestamptz(2013, 7, 15, 8, 15, 23.5);
----
2013-07-15 08:15:23.500+01:00

query T
SELECT make_timestamptz(2013, 7, 15, 8, 15, 23.5, 'America/New_York');
----
2013-07-15 13:15:23.500+01:00

statement ok
set timezone to 'UTC';