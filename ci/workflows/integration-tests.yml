auto-retry: &auto-retry
  automatic:
    # Agent terminated because the AWS EC2 spot instance killed by AWS.
    - signal_reason: agent_stop
      limit: 3

steps:
  # We ingest both json and protobuf data for a few demos.
  # For rest of demos, we run only one format (json).
  - label: "Run Demos {{matrix.testcase}} {{matrix.format}}"
    command: "ci/scripts/integration-tests.sh -c {{matrix.testcase}} -f {{matrix.format}}"
    timeout_in_minutes: 30
    retry: *auto-retry
    plugins:
      - seek-oss/aws-sm#v2.3.1:
          env:
            GHCR_USERNAME: ghcr-username
            GHCR_TOKEN: ghcr-token
      - ./ci/plugins/docker-compose-logs
    matrix:
      setup:
        testcase:
          - "livestream"
          - "twitter"
        format:
          - "json"
          - "protobuf"

  - label: "Run Demos {{matrix.testcase}}"
    command: "ci/scripts/integration-tests.sh -c {{matrix.testcase}} -f json"
    timeout_in_minutes: 30
    retry: *auto-retry
    plugins:
      - seek-oss/aws-sm#v2.3.1:
          env:
            GHCR_USERNAME: ghcr-username
            GHCR_TOKEN: ghcr-token
      - ./ci/plugins/docker-compose-logs
    matrix:
      setup:
        testcase:
          - "ad-click"
          - "ad-ctr"
          - "cdn-metrics"
          - "clickstream"
          - "livestream"
          - "prometheus"
          - "schema-registry"
          - "mysql-cdc"
          - "postgres-cdc"
          - "mysql-sink"
          - "postgres-sink"
          - "iceberg-cdc"
          # - "iceberg-sink"
          - "debezium-mysql"

  # NOTE: buildkite matrix-limits
  # Each build matrix has a limit of 6 dimensions, 20 elements in each dimension and a total of 12 adjustments.
  - label: "Run Demos {{matrix.testcase}} {{matrix.format}}"
    command: "ci/scripts/integration-tests.sh -c {{matrix.testcase}} -f json"
    timeout_in_minutes: 30
    retry: *auto-retry
    plugins:
      - seek-oss/aws-sm#v2.3.1:
          env:
            GHCR_USERNAME: ghcr-username
            GHCR_TOKEN: ghcr-token
      - ./ci/plugins/docker-compose-logs
    matrix:
      setup:
        testcase:
          - "twitter"
          - "twitter-pulsar"
          # - "debezium-mongo"
          - "debezium-postgres"
          - "tidb-cdc-sink"
          - "debezium-sqlserver"
          - "citus-cdc"
          - "kinesis-s3-source"
          - "clickhouse-sink"
          - "cockroach-sink"
          - "kafka-cdc-sink"
          - "cassandra-and-scylladb-sink"
          - "elasticsearch-sink"
          - "redis-sink"
          - "vector"

  - label: "Run Demos {{matrix.testcase}} {{matrix.format}}"
    command: "ci/scripts/integration-tests.sh -c {{matrix.testcase}} -f json"
    timeout_in_minutes: 30
    retry: *auto-retry
    plugins:
      - seek-oss/aws-sm#v2.3.1:
          env:
            GHCR_USERNAME: ghcr-username
            GHCR_TOKEN: ghcr-token
      - ./ci/plugins/docker-compose-logs
    matrix:
      setup:
        testcase:
          - "vector"
