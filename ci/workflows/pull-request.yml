auto-retry: &auto-retry
  automatic:
    # Agent terminated because the AWS EC2 spot instance killed by AWS.
    # "Exited with status 255 (after intercepting the agentâ€™s termination signal, sent because the agent was stopped)"
    - exit_status: 255
      limit: 2

steps:
  - label: "check ci image rebuild"
    plugins:
      - chronotc/monorepo-diff#v2.3.0:
          diff: "git diff --name-only origin/main"
          watch:
            - path: "ci/build-ci-image.sh"
              config:
                command: "ci/build-ci-image.sh"
                label: "ci build images"
  - wait

  - label: "build"
    command: "ci/scripts/build.sh -p ci-dev"
    key: "build"
    plugins:
      - docker-compose#v4.9.0:
          run: rw-build-env
          config: ci/docker-compose.yml
          mount-buildkite-agent: true
    timeout_in_minutes: 1
    retry: *auto-retry
