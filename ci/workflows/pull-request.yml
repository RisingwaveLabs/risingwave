steps:
  - label: "check ci image rebuild"
    plugins:
      - chronotc/monorepo-diff#v2.3.0:
          diff: "git diff --name-only origin/main"
          watch:
            - path: "ci/build-ci-image.sh"
              config:
                command: "ci/build-ci-image.sh"
                label: "ci build images"
  - wait

  - label: "build (dev mode)"
    command: "ci/scripts/build.sh -p ci-dev"
    key: "build-dev"
    plugins:
      - docker-compose#v4.9.0:
          run: rw-build-env
          config: ci/docker-compose.yml
          mount-buildkite-agent: true
    timeout_in_minutes: 15

  - label: "docslt"
    command: "ci/scripts/docslt.sh"
    key: "docslt"
    plugins:
      - docker-compose#v4.9.0:
          run: rw-build-env
          config: ci/docker-compose.yml
          mount-buildkite-agent: true
    timeout_in_minutes: 10

  - label: "end-to-end test (parallel) (dev mode)"
    command: "ci/scripts/e2e-test-parallel.sh -p ci-dev"
    depends_on:
      - "build-dev"
      - "docslt"
    plugins:
      - seek-oss/aws-sm#v2.3.1:
          env:
            BUILDKITE_ANALYTICS_TOKEN: buildkite-build-analytics-sqllogictest-token
      - docker-compose#v4.9.0:
          run: rw-build-env
          config: ci/docker-compose.yml
          mount-buildkite-agent: true
      - test-collector#v1.0.0:
          files: "*-junit.xml"
          format: "junit"
      - ./ci/plugins/upload-failure-logs
    timeout_in_minutes: 20

  - label: "misc check"
    command: "ci/scripts/misc-check.sh"
    plugins:
      - docker-compose#v4.9.0:
          run: rw-build-env
          config: ci/docker-compose.yml
      - shellcheck#v1.2.0:
          files: ./**/*.sh
    timeout_in_minutes: 5

  # Generates cpu flamegraph env
  - label: "flamegraph-env-build"
    key: "flamegraph-env-build"
    command: "ci/scripts/flamegraph-env-build.sh"
    if: build.pull_request.labels includes "cpu_flamegraph" || build.pull_request.labels includes "heap_flamegraph"
    plugins:
      - seek-oss/aws-sm#v2.3.1:
          env:
            GITHUB_TOKEN: github-token
      - docker-compose#v4.9.0:
          run: rw-build-env
          config: ci/docker-compose.yml
          mount-buildkite-agent: true
          environment:
            - GITHUB_TOKEN
    timeout_in_minutes: 20

  # Generates cpu flamegraph if label `cpu_flamegraph` is added to PR.
  - label: "Generate CPU flamegraph"
    command: "PULL_REQUEST=$BUILDKITE_PULL_REQUEST ci/scripts/gen-flamegraph.sh cpu"
    depends_on: "flamegraph-env-build"

    if: build.pull_request.labels includes "cpu_flamegraph"

    plugins:
      - seek-oss/aws-sm#v2.3.1:
          env:
            GITHUB_TOKEN: github-token
      - docker-compose#v4.9.0:
          run: ci-flamegraph-env
          config: ci/docker-compose.yml
          mount-buildkite-agent: true
          environment:
            - GITHUB_TOKEN
    # TODO(kwannoel): Here are the areas that can be further optimized:
    # - Nexmark event generation: ~3min for 100mil records.
    # - Generate Flamegraph: ~15min (see https://github.com/koute/not-perf/issues/30 on optimizing)
    # - Building RW artifacts: ~8min
    timeout_in_minutes: 90 # ~3-4 queries can run

  # Generates heap flamegraph if label `heap_flamegraph` is added to PR.
  - label: "Generate Heap flamegraph"
    command: "PULL_REQUEST=$BUILDKITE_PULL_REQUEST ci/scripts/gen-flamegraph.sh heap"
    depends_on: "flamegraph-env-build"

    if: build.pull_request.labels includes "heap_flamegraph"

    plugins:
      - seek-oss/aws-sm#v2.3.1:
          env:
            GITHUB_TOKEN: github-token
      - docker-compose#v4.9.0:
          run: ci-flamegraph-env
          config: ci/docker-compose.yml
          mount-buildkite-agent: true
          environment:
            - GITHUB_TOKEN
    # TODO(kwannoel): Here are the areas that can be further optimized:
    # - Nexmark event generation: ~3min for 100mil records.
    # - Generate Flamegraph: ~15min (see https://github.com/koute/not-perf/issues/30 on optimizing)
    # - Building RW artifacts: ~8min
    timeout_in_minutes: 60 # ~3-4 queries can run

  # Backwards compatibility tests
  - label: "Backwards compatibility tests"
    command: "RW_COMMIT=$BUILDKITE_COMMIT ci/scripts/backwards-compat-test.sh -p ci-dev"
    if: |
      build.pull_request.labels includes "breaking-change" ||
        build.pull_request.labels includes "ci/run-backwards-compat-tests"
    depends_on:
      - "build"
    plugins:
      - docker-compose#v4.9.0:
          run: ci-flamegraph-env
          config: ci/docker-compose.yml
          mount-buildkite-agent: true
    timeout_in_minutes: 20
